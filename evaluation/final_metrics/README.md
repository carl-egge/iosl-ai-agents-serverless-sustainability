# Final Metrics Calculator

Calculates per-invocation and per-year energy consumption, carbon emissions, and transfer costs from GCP Cloud Run metrics.

## Purpose

Transforms raw GCP metrics into actionable sustainability metrics for GPS-UP evaluation and comparison across different deployment strategies.

**What it calculates:**
- **Energy consumption** - compute + network (per invocation and annually)
- **Carbon emissions** - grams CO2 per invocation, kg CO2 annually
- **Transfer costs** - data transfer only (per invocation and annually)
- **Per-year metrics** - automatically scaled from invocations_per_day in function_metadata.json

**What it does NOT calculate:**
- Container costs (CPU, memory, GPU, request costs) - these don't vary by region and are deferred to future work
- Free tier savings - deferred to future work
- Latency metrics - handled by loadgen tool

## Prerequisites

1. **GCP metrics file** - Generated by `evaluation/gcp_metrics/fetch_metrics.py`
2. **Function metadata** - `local_bucket/function_metadata.json` (for memory/CPU allocation)
3. **Static configuration** - `local_bucket/static_config.json` (for power constants, pricing)
4. **Carbon intensity** - Average gCO2/kWh value (passed as CLI argument)

## Installation

No additional dependencies required - uses Python standard library only. All dependencies are managed through the project's `environment.yml`.

## Usage

### Mode 1: Single Function

Calculate metrics for one specific function:

```bash
python calculate.py \
  --gcp-metrics ../data/gcp_metrics_dispatcher_20260111_130943.json \
  --function-name dispatcher \
  --carbon-intensity 400 \
  --output ../data/final_metrics_dispatcher_20260111_150000.json
```

**Notes:**
- Function allocation (memory, vCPUs, GPU) automatically resolved from `function_metadata.json`
- If function not found in metadata, uses defaults: 512MB, 1 vCPU, no GPU
- `--output` is optional; auto-generates path if omitted

### Mode 2: Batch Processing

Calculate metrics for all functions in GCP metrics file:

```bash
python calculate.py \
  --gcp-metrics ../data/gcp_metrics_project-a_20260111_130943.json \
  --carbon-intensity 400
```

Processes all functions automatically. Output saved to `evaluation/data/final_metrics_{experiment_name}_{timestamp}.json`

### Mode 3: Per-Year Metrics

Per-year metrics are **automatically included by default** if `function_metadata.json` is available. To disable:

```bash
python calculate.py \
  --gcp-metrics ../data/gcp_metrics_dispatcher_20260111_130943.json \
  --function-name dispatcher \
  --carbon-intensity 400 \
  --no-include-annual
```

**How it works:**
- Reads `invocations_per_day` from `local_bucket/function_metadata.json`
- Falls back to 100/day if function not found
- Scales energy (kWh → kWh/year), emissions (g → kg/year), transfer costs ($ → $/year)
- Annual invocations = invocations_per_day × 365

## Input: GCP Metrics File

Expected format (from `fetch_metrics.py`):

```json
{
  "experiment_name": "project-a-fixed-region",
  "functions": {
    "dispatcher": {
      "service_name": "dispatcher",
      "region": "us-east1",
      "gcp_metrics": {
        "request_count": 5,
        "request_latencies_ms": {"mean": 2753.32, ...},
        "cpu_utilization": {"mean": 0.0075, ...},
        "memory_utilization": {"mean": 0.2234, ...},
        "network": {
          "received_gb": 0.000027,
          "sent_gb": 0.0000092
        }
      }
    }
  }
}
```

## Output Format

### With Per-Year Metrics (Default)

```json
{
  "calculation_metadata": {
    "source_gcp_metrics": "path/to/gcp_metrics.json",
    "static_config_version": "1.0.0",
    "calculation_timestamp": "2026-01-11T15:00:00Z",
    "basis": "per_invocation_and_per_year"
  },
  "functions": [
    {
      "function_name": "dispatcher",
      "region": "us-east1",
      "inputs": {
        "allocated_memory_mb": 512,
        "allocated_vcpus": 1.0,
        "gpu_required": false,
        "carbon_intensity_g_per_kwh": 400,
        "from_gcp_metrics": {
          "request_count": 5,
          "runtime_ms": 2753.32,
          "cpu_utilization_actual": 0.0075,
          "memory_utilization_actual": 0.2234,
          "data_received_gb": 0.000027,
          "data_sent_gb": 0.0000092
        }
      },
      "per_invocation": {
        "energy": {
          "compute_energy_kwh": 0.000184,
          "network_energy_kwh": 0.00000001448,
          "total_energy_kwh": 0.00018401448,
          "breakdown": {
            "cpu_power_w": 0.01875,
            "memory_power_w": 0.2,
            "gpu_power_w": 0,
            "runtime_s": 2.753
          }
        },
        "emissions": {
          "total_carbon_g": 0.07360579
        },
        "transfer_costs": {
          "transfer_cost_usd": 0.0,
          "breakdown": {
            "total_transfer_gb": 0.0000362,
            "transfer_rate_per_gb": 0.0
          }
        }
      },
      "per_year": {
        "annual_invocations": 36500,
        "invocations_per_day": 100,
        "energy": {
          "total_energy_kwh": 6.716,
          "compute_energy_kwh": 6.716,
          "network_energy_kwh": 0.0005
        },
        "emissions": {
          "total_carbon_kg": 2.687
        },
        "transfer_costs": {
          "annual_transfer_cost_usd": 0.0
        }
      }
    }
  ]
}
```

## Calculation Methodology

### Energy Calculation

**Per-invocation energy (kWh) = Compute energy + Network energy**

**Compute energy:**
```
cpu_power_w = allocated_vcpus × 2.5W × cpu_utilization_actual
memory_power_w = allocated_memory_gib × 0.4W
gpu_power_w = 1 × 72W × 0.8 (if GPU required, else 0)

compute_energy_kwh = (cpu_power_w + memory_power_w + gpu_power_w) × (runtime_s / 3600) × 1.1 (PUE)
```

**Network energy:**
```
network_energy_kwh = (data_received_gb + data_sent_gb) × 0.002 kWh/GB / request_count
```

**Key features:**
- Uses **actual CPU utilization** from GCP metrics (not static 50% assumption)
- GPU power calculated only if `gpu_required=true` in function metadata
- Memory power always calculated (memory is always "on")
- PUE (Power Usage Effectiveness) factor of 1.1 applied to compute energy

### Emissions Calculation

```
emissions_g_co2 = total_energy_kwh × carbon_intensity_g_per_kwh
```

Carbon intensity is provided by user (average for region/time window).

### Transfer Cost Calculation

```
transfer_cost_usd = (data_received_gb + data_sent_gb) / request_count × transfer_rate_per_gb
```

**Transfer rates by region:**
- us-east1 (same as bucket): $0.00/GB
- North America: $0.02/GB
- Europe: $0.05/GB

**Note:** Compute costs (CPU, memory, invocation, GPU) are NOT included because they don't vary significantly by region for comparison purposes.

## Function Allocation Resolution

Memory and vCPU allocation resolved in priority order:

1. **`function_metadata.json`** - If function name matches:
   - Memory: from `memory_mb` field
   - vCPUs: from `static_config.json` defaults (1 for non-GPU, 8 for GPU)
   - GPU: from `gpu_required` field

2. **Defaults** - If function not found:
   - Memory: 512MB
   - vCPUs: 1
   - GPU: false

## Power Constants

All values loaded from `local_bucket/static_config.json`:

- CPU: 2.5W per vCPU
- Memory: 0.4W per GiB
- Network: 0.002 kWh per GB
- Datacenter PUE: 1.1
- GPU (nvidia-l4): 72W TDP × 0.8 utilization = 57.6W effective

## Examples

### Example 1: Calculate for Single Function

```bash
python calculate.py \
  --gcp-metrics ../data/gcp_metrics_dispatcher_20260111_130943.json \
  --function-name dispatcher \
  --carbon-intensity 400
```

Output: `evaluation/data/final_metrics_dispatcher_20260111_HHMMSS.json`

### Example 2: Calculate for All Functions in Project

```bash
python calculate.py \
  --gcp-metrics ../data/gcp_metrics_project-a-fixed-region_20260111_130943.json \
  --carbon-intensity 450 \
  --output ../data/final_metrics_project-a.json
```

### Example 3: Compare Regions

```bash
# Calculate for us-east1 deployment
python calculate.py \
  --gcp-metrics ../data/gcp_metrics_us-east1_20260111.json \
  --carbon-intensity 400

# Calculate for europe-west1 deployment
python calculate.py \
  --gcp-metrics ../data/gcp_metrics_europe-west1_20260111.json \
  --carbon-intensity 350
```

Compare transfer_cost_usd between outputs.

## Integration with Other Tools

### Workflow

1. **Deploy functions** to different regions
2. **Generate load** with `evaluation/loadgen/loadgen.py`
3. **Fetch GCP metrics** with `evaluation/gcp_metrics/fetch_metrics.py`
4. **Calculate final metrics** with this tool
5. **Compare results** across deployment strategies

### Full Example

```bash
# Step 1: Deploy to us-east1 (done manually or via deployment scripts)

# Step 2: Generate load
cd evaluation/loadgen
python loadgen.py

# Step 3: Fetch GCP metrics for the same time window
cd ../gcp_metrics
python fetch_metrics.py \
  --project-id my-project \
  --url https://dispatcher-hash.run.app \
  --start "2026-01-10T10:00:00Z" \
  --end "2026-01-10T10:05:00Z"

# Step 4: Calculate final metrics
cd ../final_metrics
python calculate.py \
  --gcp-metrics ../data/gcp_metrics_dispatcher_20260110_100500.json \
  --function-name dispatcher \
  --carbon-intensity 400
```

## Troubleshooting

### Function not found in metadata
If you see allocation fallback to defaults:
- Ensure function name matches exactly (case-sensitive)
- Check `local_bucket/function_metadata.json` contains the function
- Verify function_id field matches the function name

### Missing GCP metrics fields
Ensure your GCP metrics file contains:
- `request_latencies_ms.mean`
- `cpu_utilization.mean`
- `network.received_gb` and `network.sent_gb`
- `request_count`

### GPU calculations
For GPU functions (e.g., `image_format_converter`):
- Ensure `gpu_required: true` in function_metadata.json
- GPU power will be: 1 × 72W × 0.8 = 57.6W
- vCPUs automatically set to 8 (GPU requirement)

## Carbon Intensity Values

Common carbon intensity values (gCO2/kWh):

- **Clean energy regions:**
  - Finland (europe-north1): ~100
  - Sweden (europe-north2): ~50
  - Montreal (northamerica-northeast1): ~30

- **Mixed energy regions:**
  - US Average: ~400
  - Germany (europe-west3): ~350
  - UK (europe-west2): ~250

- **Carbon-intensive regions:**
  - Poland (europe-central2): ~700
  - India: ~650
  - China: ~550

For evaluation, use regional average or fetch real-time data from Electricity Maps API.

## Files

- `calculate.py` - Main calculation script
- `.env.example` - Optional environment configuration template
- `README.md` - This file

## See Also

- [../gcp_metrics/README.md](../gcp_metrics/README.md) - Fetching GCP metrics
- [../loadgen/README.md](../loadgen/README.md) - Load generation
- [../../local_bucket/static_config.json](../../local_bucket/static_config.json) - Power constants and pricing
- [../../local_bucket/function_metadata.json](../../local_bucket/function_metadata.json) - Function specifications
